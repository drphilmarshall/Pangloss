%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Pangloss: Testing the reconstruction method
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\documentclass[useAMS,usenatbib]{mn2e}
%% letterpaper
%% a4paper

% \voffset=-0.8in

% Packages:
\input psfig.sty
\usepackage{xspace}
\usepackage{graphicx}
\usepackage{amssymb}
\usepackage{amsmath}

% Macros:
\input{macros.tex}
\input{addresses.tex}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\title[Line of Sight Mass Reconstruction]
{Reconstructing the Lensing Mass in the Universe \\
from Photometric Catalog Data}
    
\author[Collett \etal]{%
  Thomas~E.~Collett$^{1}$\thanks{\collettemail},
  Philip~J.~Marshall$^{2}$,
  Matthew~W.~Auger$^{1}$,
  Stefan~Hilbert$^{3}$,
\newauthor{%
  Sherry~H.~Suyu$^{4}$,
  Zachary~Greene$^{4}$,
  Tommaso~Treu$^{4}$\thanks{\packard},
  Vasiliy~Belokurov$^{1}$,}
\newauthor{%
  Christopher~D.~Fassnacht$^{5}$,
  L\`eon~V.~E.~Koopmans$^{6}$,
  Roger~D.~Blandford$^{3}$} 
  \medskip\\
  $^1$\ioa\\
  $^2$\oxford\\
  $^3$\kipac\\
  $^4$\ucsb\\
  $^5$\davis\\
  $^6$\kapteyn
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{document}
             
\date{to be submitted to MNRAS}
\pagerange{\pageref{firstpage}--\pageref{lastpage}}\pubyear{2012}

\maketitle           

\label{firstpage}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{abstract} 

High precision cosmological distance measurements towards individual objects
such as time delay gravitational lenses or type Ia supernovae are affected by
weak lensing perturbations by galaxies and groups along the line of sight.
Such massive structures contribute an ``external convergence'' $\kappa$ that
in some cases dominates the uncertainty in the inferred distances.  We
characterise this uncertainty by marginalising over a probability density
function for $\kappa$: here, we investigate the use of a simple halo model to
estimate $\pr(\kappa|\data)$ given noisy estimates of the photometric redshift
and stellar mass of galaxies observed in optical imaging surveys of the field
in question. We use mock catalogs from the Millennium Simulation, and compare
our reconstructed $\pr(\kappa|\data)$ to ray-traced $\kappa$ truth values: 
taking into account realistic uncertainties on redshift and stellar masses, we
typically find that the reconstruction yields an improvement in precision of
40\% over the global $\pr(\kappa)$. For any given line of sight the
convergence estimate can be made before the investment of expensive follow-up
observations: we find that selecting systems by the precision with which
$\kappa$ can be estimated leads to a low density sample that would give
distance estimates a factor of 2 more precise, with biases as low as 0.5\%.
Preferentially selecting lines of sight with high external shear (as might
happen in an assembled sample of quadruply-imaged time delay lenses) has the
opposite effect, with distances biased by around 1\%. We suggest areas for the
improvement of this general analysis framework that should allow yet more
accurate cosmological inferences to be made.

\end{abstract}

% Full list of options at http://www.journals.uchicago.edu/ApJ/instruct.key.html

\begin{keywords}
  gravitational lensing   --
  methods: statistical    --
  galaxies: halos         --
  gaaxies: mass function  --
  cosmology: observations
\end{keywords}

\setcounter{footnote}{1}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Introduction}
\label{sec:intro}

Every distant object we observe has had its apparent shape distorted,
and size and total brightness magnified (or demagnified) by a compound
weak gravitational lens constructed from all the mass distributed
between us and it. As \citet{Vale+White2003} and \citet{HilbertEtal2007}
showed, there are no empty lines of sight through our universe. This
fact makes gravitational lensing a potentially important source of
systematic error for any estimate of luminosity (or distance); this 
issue has been 
raised for \eg type Ia supernovae by
\citet[][]{Holz+Wald1998,Holz+Linder2005}, for gamma ray bursts by
\citet[][]{Oguri+Takahashi2006,Wang+Dai2011},  and for high redshift
galaxies by \citet{BradacEtal2009}, among others. 

Along lines of sight containing strong gravitational lenses, the
perturbative effects of line of sight mass structure have been found to
be particularly important, with foreground and background structures
having a significant effect on the inferred lensing cross-section
\citep[\eg][]{WongEtal2012} and distance ratios
\citep[][]{DalalEtal2005}. Indeed, \citet{SuyuEtal2010} found that in
time delay lens cosmography the so-called ``external convergence''
$\kappa$ due to mass structures along the (unusually over-dense) line
of sight to the quadruply-imaged radio source B1608$+$656 was the
dominant source of uncertainty in their 6\% measurement of Hubble's
constant. The problem is that one simply doesn't know how magnified and
distorted the source has been, because the unlensed source is
unobservable. The external shear can potentially be recovered in the
mass-modelling of the lens, but the convergence is undetectable from the
image positions, shapes and relative fluxes; this is the famous {\emph{ 
mass sheet-degeneracy}} \citep[see e.g.][for details]{FalcoEtal1985}.

How can we correct for this perturbative lensing and make accurate
measurements through the Universe? When inferring global quantities
(such as the cosmological parameters), combining the results from a
large number of independent objects will tend to reduce the uncertainty
due to external convergence, as the ensemble-averaged magnification
approaches zero for an unbiased sample \citep[\eg][]{Holz+Linder2005}.
If the sample is biased, however, some residual systematic error will
remain even as the statistical uncertainty decreases. Lensing bias will
be present (to varying degrees) in any sample {\it selected} by
brightness (which includes magnification), or any other quantity that
depends on $\kappa$. This bias may be introduced either at the object
detection stage, or later on when making decisions about which objects
to study further.  Moreover, we expect these biases to be strongest in
the strong lens systems, where magnification is highest. Large samples
of lenses are expected to be discovered in the next decade in
ground-based optical imaging surveys \citep{Oguri+Marshall2010}: both
the detectability of these lenses,  and the selection of sub-samples of
them for further observation, could be sensitive to the external
convergence. 

Several attempts have been made to do better than simply constructing a
large sample of objects, and averaging over the resulting convergence
distribution. The weak lensing effect can be detected observationally 
by measuring the
small distortions it induces on the images of many background galaxies
in the field \citep[see e.g.][for a review]{Schneider2006}. In a 30''
radius aperture around the strong lens Q0957$+$561,
\citet{NakajimaEtal2009} used deep HST imaging to measure a weak lensing
convergence of $0.17\pm0.06$, which was used in the time delay distance
measurement of \citep{FadelyEtal2009}. While this system has an
unusually high external convergence due to its location on the edge of a
cluster of galaxies, the precision with which the convergence at the
lens position can be estimated is indicative of what can be achieved
with high quality weak lensing shear data. We note that this uncertainty
is not dependent on the value of the convergence, but instead depends
primarily on the number density of weakly lensed, measurable galaxies
available. 

In order to make more precise estimates of the convergence at a given
sky position, we need more information.   There have been some attempts
to reconstruct the local and line of sight mass distribution in strong
lens fields in some detail, based on photometric and spectroscopic
surveys of the galaxies nearby. These efforts have focused on  detecting
galaxy groups, ascertaining the visible galaxies' membership of those
groups, and assigning mass to the group and galaxy halos in order to
predict the external shear apparently required by the strong lens
models. Surveys by
\citet{Fassnacht+Lubin2002,AugerEtal2007,WilliamsEtal2006,MomchevaEtal2006}
all found groups of galaxies both hosting, and lying  along the line of
sight to, known gravitational lenses. Initial estimates of the effect of
these structures suggested the importance of assigning mass to both
galaxy and group halos, and to allowing for significant uncertainty in
the centroids of group halos. 

The probability density function (PDF) for the external convergence
given our available data $\data$, $\Pr(\xkappa|\data)$,  is the  key
quantity we seek, since by marginalising over this distribution we can
correctly propagate the uncertainties due to line-of-sight perturbations
(as \citeauthor{FadelyEtal2009} did).  
%
\citet{GunnarssonEtal2006} investigated a related PDF,  for the
magnification, using a galaxy halo model. Applying empirical galaxy
scaling relations both to simulate mock catalogs and then to reconstruct
the line of sight mass distribution. While they did not explore highly
overdense lines of sight, or the impact of groups and clusters, they
found that under their simplifying assumptions, the dispersion in
apparent source brightness due to lensing magnification could be reduced
by a factor of two.
%
\citet{WongEtal2011} estimated the PDF for the external shear,
$\Pr(\gamma|\data)$ from their survey data, running similar Monte Carlo
reconstructions of the mass in nine lens fields based on
\citeauthor{WilliamsEtal2006} and \citeauthor{MomchevaEtal2006}'s
photometric and spectroscopic measurements of galaxies close to the line
of sight. They then  compared the resulting predicted shear
distributions with the external shear demanded by the strong lens model.
Their reconstructions showed most of the shear to have been generated by
bright galaxies within 2~arcminutes of the lens, and that both line of
sight structures and the group of galaxies in each lens plane contribute
significant proportions of the shear. They found significant
discrepancies between the lens model shear and the Monte Carlo
predictions, but were unable to distinguish between the environment
modelling and the strong lens modelling as the cause of these
discrepancies.

These observational investigations have provided some very useful
insight into the problem of convergence estimation.  Coming from a more
theoretical direction, large numerical simulations have been used to
predict, from first principles, the distribution of likely external
shears and convergences along various lines of sight, including those
containing strong lens systems.  \citet{Holder+Schechter2003} and
\citet{DalalEtal2005} carried out ray-tracing calculations in N-body
simulations to estimate the distribution of external shear values. 
\citet{HilbertEtal2009} performed similar ray-tracing experiments
through the Millenium Simulation \citep{SpringelEtal2005}, generating a
predicted $\kappa$ at every position in a simulated sky.
\citet{HilbertEtal2009} found that \MS lines of sight with strong lenses
were not biased towards high $\kappa$, although selection functions for
discovering or using particular samples of strong lenses were not taken
into account. Addressing the possibility of using weak lensing shear to
reconstruct the magnification~$\mu$ that affects cosmography with
standard candles (and standard sirens), \citet{HilbertEtal2011} used the
\MS ray-tracing results to explore optimal mapping techniques and
quantify their performance. They found that deep weak lensing shear
surveys (with background galaxy number densities of 100 arcmin$^{-2}$)
would enable $\Pr(\mu|\data)$ to be estimated such that the distance
uncertainty per object would be reduced by  20\% on average, and by 40\%
in regions of low convergence, leading to the suggestion that weak
lensing maps be used to identify the (low convergence)  lines of sight
that give higher precision distance estimates.

The \MS results have been used to analyse real observations as well. 
\citet{SuyuEtal2010} selected \MS lines of sight by their apparent
galaxy overdensity, in a 45 arcsec radius aperture down to $i < 24.5$,
to match the observed overdensity towards the time delay lens
B1608$+$656 \citep{FassnachtEtal2011}.  The resulting distribution of
$\kappa$ values from the ray-tracing was taken to be an estimate of 
$\Pr(\kappa)$, which was then marginalised over when inferring the time
delay distance in this system. 
% B1608$+$656 is indeed a high $\kappa$
% line of sight, but it does not reside in a massive cluster environment.
In a companion paper to this one, Greene et al (submitted) investigate
improvements to this method by weighting the galaxy counts by galaxy
mass, and perpendicular distance to the line of sight, again using the
\MS mock catalogs and their associated $\kappa$ values to construct
$\Pr(\kappa|\data)$.

In this paper, we combine the halo model reconstruction approach of
\citeauthor{GunnarssonEtal2006} and \citeauthor{WongEtal2011}, with the
idea of calibrating to simulations from \citeauthor{SuyuEtal2010}, in
order to put the halo model for  estimating the weak lensing convergence
due to mass along the line of sight to a distant source into a sound
framework for evaluating this important source of systematic
uncertainty, as we look forward to ever increasing sample sizes and
statistical precision. Taking the $\kappa$ values from
\citeauthor{HilbertEtal2009}'s ray-tracing calculations as the ``truth''
that we have to recover, we use the \MS mock galaxy catalogs first to
{\it calibrate} the reconstruction, and account for unseen mass and
voids, and then to {\it test} the accuracy of the line of sight mass
reconstruction under this assumption. Probabilistically assigning mass
and redshift to every observed galaxy in a given observed field, we
generate Monte Carlo sample line of sight mass distributions, and so
construct the PDF $\Pr(\kappa|\data)$ for that field. We then emulate
the combination of many such PDFs to quantify the residual biases that
would be translated to the global (including cosmological) parameters.
In doing so, we aim to answer the following questions: 

\begin{itemize}

\item Faint galaxies, filaments and dark structures will not appear in
any photometric object catalog, but they will contribute convergence at
some level. How much of the total convergence comes from visible
galaxies, and how much effect do dark structures and voids have? 

\item Can the true convergence be recovered from a calibrated halo model
reconstruction? What scatter and residual bias are induced by the
reconstruction process, and how might these be reduced in the future? 

\item We have some choices to make when planning follow-up observations
of interesting sightlines. How should we select objects to achieve the
highest accuracy convergence reconstruction? Can such a selection be
made robustly, using the reconstruction results?

\end{itemize}


This paper is organized as follows. We review the relevant gravitational
lensing theory in~\Sref{sec:theory}, and the Millenium Simulation
ray-traced convergences and mock catalogs in \Sref{sec:MS}, before
introducing our simple reconstruction  model in \Sref{sec:model}. We
then test this model in two phases: first, in \Sref{sec:knownMh+z}, with
known redshift and halo mass for every galaxy in a lens field, in order
to quantify the irreducible uncertainty due to unseen mass, and second,
in \Sref{sec:obsMstar+z}, with realistic observational uncertainties on
the observed galaxies' stellar masses and redshifts. In
\Sref{sec:biases} we investigate the potential systematic error induced
by selecting a subset of sightlines. We discuss our results in
\Sref{sec:discuss} before concluding in \Sref{sec:conclude}.

Throughout this paper magnitudes are given in the AB system and
we adopt the Millenium Simulation's ``concordance'' parameters for our reference cosmology, \ie
$h=0.73$, $\Omega_m=0.25$ and $\Omega_\Lambda=0.75$, where the symbols indicate
the Hubble Constant in units of 100 km s$^{-1}$ Mpc$^{-1}$ and the matter and
dark energy density of the Universe in units of the critical density.
.%\citep[e.g.\ ][]{KomEtal09}.



\begin{figure*}
\includegraphics[width=\textwidth]{figs/viewofalightcone.eps}
\caption[magcut]{Four different views of a slightly over-dense \MS line
of sight, with a $\kappa$ of 0.03. 
{\it Top row, left:} The positions of galaxies projected on the sky. The area
of the circles is proportional to observed $i$-band flux; the brightest
object shown has an $i$ magnitude of 17.7. 
{\it Top row, centre:} The angular sizes of halos projected on the sky.
Red and blue regions lie within the NFW scale radius and virial radius
of each halo, respectively. There are essentially no empty lightcones. 
{\it Top row, right:} The individual $\kappa$ contributions of
each halo, assuming a \citet{BMO} profile and the \citet{Neto2007}
mass-concentration relation. Comparison of
this panel and the centre panel reveals the relative importance of
proximity to the line of sight.
{\it Bottom:} A view along the redshift axis, showing only halos with
$|x|<0.3$ arcmin. The area of the points is proportional to each halo's
mass: the most massive halo shown has $1.6\times10^{12}\Msun$. The
optical axis is shown by the dashed line, while the dotted lines mark
the lens and source planes for a B1608-like strong lens.}
\label{fig:lightcone}
\end{figure*}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Theoretical Background}
\label{sec:theory}

Convergence, or Ricci focusing, occurs when a gravitational lens focuses
the rays in a given bundle. This focusing can cause distant objects to
appear brighter, and larger than they would if the lens were removed.
The convergence from an isolated mass sheet at a position
$\bmath{\theta}$ on the sky is the ratio of the projected surface
mass density ($\Sigma(D_{\mathrm{od}}\bmath{\theta})$) \devided by the
critical surface mass density at the redshift of the mass sheet
($\Sigma_{\rm cr}$),
\be
\kappa(\bmath{\theta})= \frac {\Sigma(D_{\mathrm{od}}\bmath{\theta})}
                              {\Sigma_{\rm cr}(\zd,\zs)}
\ee
where 
\be 
\label{eq:sigcrit} 
\Sigma_{\rm cr}(\zd,\zs) \equiv \frac{c^2 D_{\rm os}}{4 \pi G D_{\rm od} D_{\rm ds}}.
\ee
and the $D$'s are the angular diameter distances between the objects
refered to in the subscripts: o is the observer, d is the deflector and
s is the source. If the surface mass density of the sheet exceeds
$\Sigma_{\rm cr}$, multiple images of the source can occur, otherwise
only one image will be observed, although that image will still be
perturbed relative to the unlensed case.

\comments{
Strong lensing occurs when a massive object and background source are almost perfectly
aligned along a line of sight. The light from the background source is deflected by the
lens galaxy; this deflection allows multiple images of the background source to form
at stationary points of the time delay function. For an isolated lens, the time delay
function can be calculated from
\be \label{eq:T} 
\Delta t(\bmath{\theta},\bmath{\beta}) = \frac {1}{c} \frac{D_{\rm od} D_{\rm os}}{D_{\rm ds}} (1+z_{\rm d})\, \phi(\bmath{\theta},\bmath{\beta}),
\ee
where $\bmath{\theta}$ is the observed source position, $\bmath{\beta}$ is the 
unlensed source position, $z_{\rm d}$ is the redshift of the lens, $\phi(\bmath{\theta},\bmath{\beta})$ is
the Fermat potential. The Fermat potential is given by
\be \label{eq:FP}
\phi(\bmath{\theta},\bmath{\beta})\equiv \left[\frac{(\bmath{\theta}-\bmath{\beta})^2}{2}-\psi(\bmath{\theta}) \right], 
\ee
where $\psi(\bmath{\theta})$ is the lens potential, derived from the projected dimensionless
surface mass density, $\kappa(\bmath{\theta})$, by 
\be \label{eq:psikappa}
\kappa(\bmath{\theta})=\frac{1}{2}\nabla^2\psi(\bmath{\theta}).
\ee
}

Strong lenses sit in our real Universe -- they are not \truely isolated;
there is some mass along the line of sight coming from intervening
structures. These structures may be physically associated with the lens
e.g. other members of a group or cluster, or they may be the result of
chance alignments at any redshift.  Whilst it is rare for three galaxies
to line up well enough for both of the background sources to be strongly
lensed \citep{GavazziEtal2008,CollettEtal2012a}, the large size of dark
matter halos makes a partial alignment -- with the additional structure
acting as a perturbing weak lens --  a near certainty
\citep{Vale+White2003,HilbertEtal2007}. These additional structures
induce an external shear which can be recovered in the mass-modelling of
the lens, but they can also introduce a convergence that is undetectable
from the image positions, shapes and relative fluxes
\citep{FalcoEtal1985}.

If the intrinsic source brightness changes, the observed brightness in
each image does not change simultaneously: there will be a time delay,
$\Delta t$, between the brightness change in each image. Despite the
invariance of the image positions and fluxes, under the addition of an
external convergence (and appropriate re-scaling of the lens potential)
the relative Fermat potential between the images is {\it not} invariant,
and so the time delay changes. As such it is necessary to include
$\kappa$ in the lens modelling, if cosmological parameters are to be
estimated accurately and precisely from observed time delays
\citep{SuyuEtal2010}. Mass distributions that are physically associated with the lens galaxy
will affect the stellar dynamics of the lens galaxy, so that dynamical
observations can break the internal mass-sheet degeneracy by providing
an additional estimate of the lens galaxy's mass
\citep[e.g.,][]{SuyuEtal2010}. In this work our aim is to quantify the
lensing effect of massive objects, regardless of their position along
the line of sight.

If there is external convergence present that is not included in the
lens modeling, then the time delay distance -- inferred assuming $\kappa
= 0$ -- will be $(1-\kappa)$ less than the true value of $\Dt$:
\be 
\label{eq:MassSheet:Dtbias}
\Dt^{\rm{true}}=(1-\kappa) \Dt^{{\kappax = 0}}.
\ee
We can hence estimate the true distance if we have  with additional
knowledge of $\kappa$. Since $\kappa$ is typically small the absolute
uncertainty on the estimate of $\kappa$ \correspends to the fractional
uncertainty with which time-delay distances can be \infered.

The relationship between convergence $\kappa$ and magnification $\mu$ is
\bea 
\mu &=&       \frac{1}{(1-\kappa)^2 - |\gamma|^2}, \notag \\
    &\approx& (1+2\kappa)
\label{eq:MassSheet:mag}
\eea
where we have used the facts that the magnitude of the gravitational
shear at any point is typically comparable to the magnitude of the 
convergence, and that both are typically small. 
Under these assumptions, the fractional uncertainty in the
inferred luminosity of a magnified source will be approximately  twice
the absolute uncertainty in the convergence~$\kappa$. These
relationships will allow us to put our results on convergence estimation
in context.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{The Millennium Simulation}
\label{sec:MS}

In order to test the accuracy of our convergence estimates, we need to
know the true convergence for each line of sight. We cannot use  real
lines of sight for this,  but must use simulated lines of sight instead.
In this section we briefly review the Millenium Simulation, the ray
tracing calculations that have been carried out in it, and the mock
galaxy catalogs that have been produced.

The \MS \citep{SpringelEtal2005} is a cosmological N-body simulation of
Dark Matter structures in a cubic region approximately 680~Mpc in
comoving size, followed from redshift 127 to the present day. With an
approximate halo mass resolution of $2\times10^{10}{\rm M}_{\odot}$
(corresponding approximately to a galaxy with luminosity $0.1L^{*}$), it
provides a detailed prediction for the distribution of dark structures
present in the Universe, under the assumptions of the $\Lambda$CDM model
of hierarchical structure formation, cosmological densities as given at
the end of \Sref{sec:intro}, and $\sigma_8 = 0.9$. 
Galaxy properties,
such as stellar masses, luminosities and colours, were assigned to the
simulated halos according to a semi-analytic model for galaxy formation
\citep{DeLucia+Blaizot2007}: the resulting predictions for the galaxy
luminosity function and correlation function match the observational
data very well.

% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % 

\subsection{Convergence from Ray Tracing}
\label{sec:MS:raytracing}

\citet{HilbertEtal2009} calculated the lensing convergence using the
``lightcone'' dark matter only 
output of the \MS, providing 1.7 degree square 
mock sky maps of this
quantity. In this process, the dark matter density from the simulation
was projected onto a set of lens planes at discrete redshifts,
adaptively gridded and smoothed, and then the second derivatives of the 
lensing potential required for the components of the magnification
matrix were computed using a multiple lens plane ray tracing algorithm.
The first order approximation to this algorithm \citep[equation 17
of][]{HilbertEtal2009} gives the total convergence at a given sky
position~$\bmath{\theta}$ as the simple summation of the surface density
in each lens plane, weighted by the inverse critical surface density
$\Sigma_{\rm cr}$ for that plane's redshift:
\be
\kappa(\bmath{\theta}) = \sum_i \frac{\Sigma_i(\bmath{\theta})}
                                     {\Sigma_{\rm cr}(z_i,\zs)}.
\ee
This approximation was found to be accurate to a few percent or better
in $\kappa$, even on 30 arcsecond scales.

To define a test line of sight, we draw a random sky position from
within the convergence maps, bilinearly interpolate between the pixels
of the map, and store the result as the ``true'' convergence for that
line of sight, $\kappa_{\rm true}$. 

\todo{Stefan}{Check this is all accurate and complete!}

% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % 

\subsection{Mock Photometric Galaxy Catalogs}
\label{sec:MS:mocks}

We construct mock photometric galaxy catalogs by selecting all \MS
galaxies within a circular aperture of a given angular radius centred on
the line of sight position, with apparent $i$-band magnitude brighter
than a given limit. The parent catalog, from \citet{HilbertEtal2011},
contains galaxy positions and magnitudes, all of which include lensing
effects (deflections and magnifications). We also have access to the
underlying galaxy halo masses and redshifts, which we will use to
calibrate the reconstruction, and also to explore any sources of bias
and scatter. Since the true convergence is that of only the dark matter,
we focus on reconstructing the dark matter halos alone. Our model for
doing this is outlined in the next section. 

\todo{Stefan, Tom}{Check this is all accurate and complete!}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Estimating Convergence: The Halo Model Approximation}
\label{sec:model}

One of the goals of this paper is to define a method for estimating the
convergence at any point on the sky, given a   catalog of observed
galaxy positions and properties. Typically this could be a  photometric
galaxy catalog, containing positions, brightnesses, colours, and
possibly stellar masses and redshifts for each galaxy in the field of
the lens, down to some magnitude limit. Since we cannot observe the
surface mass density of each halo directy, we need some way of
estimating the mass of each halo in the catalog, so that we can compute
its contribution to the total $\kappa$ along the line of sight \citep[as
in \eg][]{GunnarssonEtal2006,WongEtal2011}. This mass assignment recipe
will be uncertain, but can be calibrated with cosmological simulations.

Transforming an observed photometometric galaxy catalogue into a 
catalogue of halo masses, positions, and redshifts, will enable us to
attempt a reconstruction of the convergence induced by every halo near a
line of sight. This is the subject of Section \ref{sec:model:halos}. We
also need to account for the mass in the Universe that is not associated
with the galaxies we can see -- this is the subject of Section
\ref{sec:model:voids}. 


% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % 

\subsection{Halos}
\label{sec:model:halos}

Cosmological dark matter simulations have shown that dark matter
halos are well-approximated by NFW profiles \citep{NFW}, with a density
profile given by
\be\label{eq:rhonfw}
\rho(r) = 
\frac{\rho_0}{\left(r/r_{s}\right)
\left(1+r/r_{s}\right)^{2}},
\ee
where $r_{s}$ is a characteristic radius of the cluster, representing where
the density slope transitions from $r^{-1}$ to $r^{-3}$. This radius is related
to the virial radius of the halo by $r_{s}~=~r_{200}/c$, where $r_{200}$ is the radius at 
which 
\be
\rho(r_{200}) = 200\rho_{{\mathrm{crit}}}(z), \text{ where } \rho_{\mathrm{crit}}(z) \equiv \frac{3H^{2}(z)}{8\pi G}
\ee
and $c$ is the concentration parameter, which can be estimated from the halo's mass,
using a mass--concentration relation. Typically more massive halos are less concentrated,
but there is some scatter; we use the relation of \citet{Neto2007} to estimate $c$
from the mass enclosed within $r_{200}$, which we denote as $M_{200}$. We find our results do not change if the \citet{MaccioEtal2008} Mass--concencetration relation is used instead. The best fit relation of \citet{Neto2007} is given by
\be
c_{200} = 4.67 (M_{200}/10^{14} h^{-1} \Msun)^{-0.11}.
\ee
\todo{Tom}{Add sentence about scatter!}

$\rho_0$ is calculated from the critical density and concentration parameter:
\be
\rho_0 = \rho_{\mathrm{crit}}(z)\frac{200}{3}\frac{c^{3}}{\ln(1+c)-c/(1+c)}.
\ee

If one integrates the density profile of an NFW profile out to infinite
radius, the total mass diverges. Similarly, if the universe is
homogeneously populated with NFW halos, the projected surface mass along
any line of sight will also be divergant.\footnote{At large radius,
$\Sigma_{\rm nfw} \propto R^{-2}$, but the differential number of halos
centred within an annulus of width $\dee R$ is given by $\dee N_{\rm
annulus} \propto R \dee R$, so  $\Sigma_{\rm total} \propto
\int_{0}^{\infty} R^{-1} \dee R$, which diverges logarithmically} Since
infinite mass is unphysical, the profile must be truncated at some
point. Several truncation profiles have been suggested
\citep[e.g][]{BMO}, but beyond several virial radii, the amount of
matter associated with a halo is likely to be low. In this work we
assume the truncated NFW profile
\be\label{eq:bmoprofile}
\rho(r) = 
\frac{\rho_{\rm NFW} (r)}{1+\left(r/r_{t}\right)^2},
\ee
which is the same as the NFW profile in the limit that the truncation
radius, $r_t$ goes to infinity. We use a truncation radius of five times
the virial radius, but our results are robust for any choice of $r_t>2
\times r_{200}$. The formula for the projected surface mass density 
$\Sigma(D_{od}\theta)$ for this
mass profile is given in \citet{BMO}. 

Each halo in our catalogue then contributes to
the line of sight convergence by
\be
\label{eq:kappai}
\kappa_i =\Sigma_{i}/\Sigma_{\mathrm{cr}}(z_i,\zs),
\ee
where the critical surface density was defined in \Eref{eq:sigcrit}.
Following the first order approximation of \citet{HilbertEtal2009}
outlined in \Sref{sec:MS} above, we compute 
the total convergence from all the halos along the line
of sight using
\be 
\label{eq:kappasummu}
\kappah = \sum_{i} \kappa_i.
\ee

To estimate a halo's contribution to $\kappah$ we must first know the
halo's mass. For the sightlines of the \MS, halo masses are
known, but for  real lines of sight the halo masses have to be \infered
from whatever data is available. 
In this work we investigate the use of the empirical stellar mass --
halo mass relation for this purpose. The primary advantage of this
approach is that it is a simple, ``one size fits all'' relation that can
be applied regardless of the stellar mass observed. We discuss
additional observables that could be used to improve the precision of
the halo mass inference in \Sref{sec:discuss} below.

We use the relation of \citet{BehrooziEtal2010} to infer halo masses
from stellar masses; the details of this \proceedure are outlined in 
\Aref{appendix:MSMH}. Given an uncertain stellar mass and redshift for
each galaxy in the  catalog, we draw a sample halo mass from the PDF
that describes this uncertainty  (\Eref{eq:mhalo-mstar})  and use
\Eref{eq:kappai} to compute its contribution to the convergence,
$\kappa_i$; this can be done for all the halos along the line of sight
and summed to give a sample value of $\kappah$;  repeatedly applying
this \proceedure allows us to build up a histogram of $\kappah$ values
consistent with the data, and hence characterize $\pr(\kappah|\data)$. 

This PDF contains a hidden assumption of an uninformative prior PDF for
$\kappah$ -- in the case of infinitely poorly measured stellar masses and
redshifts, $\pr(\kappah|\data)$ will have very long tails corresponding to
very overdense sightlines that we do not believe exist. The resolution of this
is to divide out the effective prior PDF that was applied during the halo mass
estimation process (which is broad, and hance close to uniform), and apply an
additional prior on $\kappah$, given by the global underlying $\kappah$
distribution from the simulation. In the limiting  case of very poor
photometric data, $\pr(\kappah|\data)$ then defaults to this distribution.
\todo{All}{Discuss this. It ties us to the simulation, but only weakly. Is the
argument about poor data valid? Tom?}


% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % 

\subsection{Accounting for voids, filaments and other dark structures}
\label{sec:model:voids}

While halos contribute a positive convergence to $\kappa$, voids contribute
a negative convergence. When a ray bundle passes through a  region of space
that is less dense than $\rho_{\rm mean}(z)$ the rays are de-focused\footnote{In
principle, the convergence caused by halos is also caused by the overdensity,
but we neglect this effect since halos are typically much more dense than the
intergalactic medium}. Whilst the  full ray-traced solution takes into account
the effect of voids, our reconstruction cannot -- the halo catalogue does not
include voids. In principle the absence of a halo could be taken to infer a
void, but the under-density of such a void is hard to infer. Neglecting voids
would lead to a heavily biased estimate of $\kappa$. Moreover, the halos in 
the model only add mass to the background density, and that background density
already accounts for all the mass in the Universe! In order to make voids
negative relative to the mean density, we must subtract a significant smooth
mass component. The problem is that we do not have a good model for the
density structure of that smooth component. 

The solution we present here is to calibrate the relationship between halo
convergence $\kappah$ and underlying convergence $\kappa$ (as calculated
during full ray tracing) using the simulations themselves.
The halo modelling \proceedure outlined in \Sref{sec:model:halos} allows 
us to estimate 
the convergence due to halos given observations of 
mass, redshift and position,
$\pr(\kappah|\mathcal{D})$, but what we are interested in is the total convergence
along the line of sight $\pr(\kappa|\mathcal{D})$. We can obtain this by
considering the expression:
\begin{equation}
\Pr(\kappa|\mathcal{D}) = \int \dee\kappah 
   \Pr(\kappa|\kappah) \Pr(\kappah|\mathcal{D})
\label{eq:kappaconv}   
\end{equation}
The first term in the integrand relates the convergence due to model halos,
$\kappah$, to the true convergence, $\kappa$. This conditional distribution
can be constructed from the Millennium Simulation catalogs, by computing
$\kappah$ for each selected line of sight using the true values of the halo
parameters,  and accumulating $\kappah$ and $\kappa$ along a large number of
such lines of
sight to  characterize $\Pr(\kappa|\kappah)$.
For any given line of sight we can then estimate
$\pr(\kappah|\mathcal{D})$ as described above, and then
multiply it by $\Pr(\kappa|\kappah)$ and integrate out the intermediate
nuisance parameter $\kappah$. 
% We can do the marginalisation over $\kappah$
% by drawing samples from the two-dimensional grid and keeping only the
% $\kappa$ values, to form our final result, $\Pr(\kappa|\mathcal{D})$.

However, given an uncertain stellar mass to halo mass conversion, the PDF
$\pr(\kappah|\{\Mstar,z\})$ can become skewed relative to
$\pr(\kappah|\{\Mhalo,z\})$; this is because of the assymetry in the
conversion from stellar mass through halo mass into $\kappah$. A long tail of
high halo masses gives rise to a tendency to overestimate $\kappah$.
If this shift is ignored, the resulting $\Pr(\kappa|\data)$ will be 
biased towards high values of $\kappa$. 

We find that we can correct this bias to some extent by artificially 
suppressing the tails of $\pr(\kappah|\{\Mstar,z\})$. Let the median of
this PDF be denoted $\kappah^{\rm med}$. We again take a large number of
calibration sightlines from the \MS catalogs, but this time generate a mock
stellar mass catalog for each one. We then reconstruct each lightcone in the
same way as we would an observed field,
estimate $\pr(\kappah|\{\Mstar,z\})$, and extract its median. Accumulating
these samples and their corresponding true values of $kappa$, we can form the 
conditional distribution $\pr(\kappa|\kappah^{\rm med})$. 
Then, when inferring $\kappa$ from an observed photometric catalog, we would
estimate $\pr(\kappah|\{\Mstar,z\}_{\rm obs})$ 
using the halo model, compute the median value 
$\kappa_{\rm h,obs}^{\rm med}$, and then use the following alternative
version of 
\Eref{eq:kappaconv} to infer $\kappa$: 
\bea
\Pr(\kappa|\mathcal{D}) &=& \int \dee\kappah^{\rm med} 
   \Pr(\kappa|\kappah^{\rm med}) \Pr(\kappah^{\rm med}|\mathcal{D}) \notag \\
                        &=& \Pr(\kappa|\kappa_{\rm h,obs}^{\rm med}).
\label{eq:calkappaconv}   
\eea
Here, we have replaced $\Pr(\kappah^{\rm med}|\mathcal{D})$ with a delta
function centred at the observed median value $\kappa_{\rm h,obs}$. 


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Results: Perfect Halo Data}
\label{sec:knownMh+z} 

We now put the reconstruction \proceedure outlined above into practice, first
inferring $\kappa$ from $\kappah$ in the case of hypothetical galaxy catalogs
with noiseless redshifts and halo masses. The reason for doing this is to
check the validity of the calibration process, and then also to  investigate
the primary sources of the convergence. It will also provide us with a measure
of the intrinsic uncertainty introduced by our assumption of all halos being
spherically-symmetric truncated NFW halos with Neto et al concentration--mass
relation.

% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % 

\subsection{How is $\kappah$ related to $\kappa$?}

\Fref{fig:jointkh-k} shows the joint distribution of $\kappah$ and $\kappa$
values for 100,000 randomly selected \MS lines of sight, assuming noise-free
halo masses and redshifts. In this case, the PDF $\pr(\kappah|\data)$ is a
delta function: to read off $\pr(\kappa|\data)$ we must take a thin horizontal
slice across this joint distribution. Note that the joint PDF plotted in this
figure is the product of  the conditional distribution that we need for
calibration, and also the prior PDF for $\kappah$ that we need to ensure that
the global distribution of $\kappah$ values is defaulted to in the case of
poor observational data. At fixed $\kappah$ we find in \Fref{fig:jointkh-k}
that the scatter in $\kapparay$ grows with $\kappah$; our reconstruction is
better at reproducing underdense lines of sight than overdense lines of sight.
The effect of ignoring voids and the smooth mass component is evident in this
plot: $\kappah$ is significantly higher than $\kappa$, at any given $\kappa$
value. Multiplying by $\pr(\kappah|\data)$ and integrating over $\kappah$
gives a PDF for $\kappa$ centred at the correct place, by construction.

\begin{figure}
\includegraphics[width=\columnwidth]{figs/cornerplot.eps}
\caption[Biased?]{The joint distribution of 
$\kappah$ and $\kappa$, from 100,000 reconstructed lines of
sight. $\kappah$ traces $\kappa$, but with a positive offset which arises from
$\kappah$ not accounting for any voids, dark structures or smooth mass
component. At fixed $\kappah$ the scatter in $\kappa$ grows with $\kappah$.}
\label{fig:jointkh-k}
\end{figure}


% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % 

\subsection{How accurate is the $\kappah - \kappa$ calibration?}

\begin{figure}
\includegraphics[width=\columnwidth]{figs/globaldist.eps}
\caption[magcut]{Recovering the global $\pr(\kappa)$, shown in red, 
from $10^{5}$ ray-traced lines of
sight. The black curve shows a histogram of 
sample reconstructed 
$\kappa$ values, each one drawn from an inferred PDF 
$P(\kappa|\{\Mhalo,z\}$)
in one of $10^{5}$ reconstructed lines of sight. 
The reconstructions were performed given
perfect knowledge of halo mass and redshift -- in this case
the reconstruction recovers the correct convergence.}
\label{fig:globaldist}
\end{figure}

\begin{figure*}
\includegraphics[width=\textwidth]{figs/where_is_the_kappa.eps}
\caption[magcut]{Which objects dominate the external convergence for a line of
sight? From left to right, the three figures show the cumulative contribution
to the total  convergence from individual halos ($\kappah$) as a function of
1)  distance from the line of sight, 2) magnitude and 3) redshift.   In each
panel, the solid line is the median cumulative contribution over a large
sample of sightlines, while dashed and dot-dashed show the ranges enclosing 68
and 95 percent of the sightlines repectively.}
\label{fig:where}
\end{figure*}

% Since voids are not included in the halo model approximation, $\kappah$
% is a biased estimator of $\kappa$, but this can be calibrated for using
% the \proceedure of \Sref{sec:model:voids}. Taking the reconstructed
% $\kappah$ for $10^{5}$ lines of sight we form the joint
% distribution, $\pr(\kappa,\kappah)$ and marginalize over $\pr(\kappah)$ to
% give $\pr(\kappa)$. 
%
% PJM: WTF? We just went through all of this in the previous section!
% We need to check that we are doing what we say we are.

In this section, let us define the ``bias'' of the reconstruction of a given
line of sight as the difference between the expectation value of $\kappa$ over
the inferred PDF $\pr(\kappa|\data)$ and the known true value $\kappatrue$.
Let us also define the ``width,'' $\sigma_{\kappa}$, to be half the width of
the interval containing the central $68\%$ of the posterior probability
$\pr(\kappa|\data)$. 

In an ensemble of $10^{4}$ reconstructed lines of sight, we find the the mean
bias to be $-9.5\times 10^{-6}$, and the mean width to be 0.0132. This is
approximately 1.8 times smaller than the width of the global $\pr(\kappa)$. 
We find that our inferred $\kappa$ PDFs are consistent with the global
$\kappa$ distribution; Figure \ref{fig:globaldist} shows that sampling from
$\pr(\kappa|\data)$ in 100,000 reconstructed lines of sight produces a
distribution of $\kappa$ values over the sky identical to the global
$\pr(\kappa)$. Given perfect knowledge of halo mass and redshift, the
calibration \proceedure provides an unbiased estimate of $\kappa$ that is
$\sim$2 times as precise as using the global $\pr(\kappa)$.

% % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % % 

\subsection{Which halos dominate the $\kappah$ distribution?}

Before investigating the uncertainties caused by imperfect knowledge of halo
mass and redshift, we investigate the uncertainties induced by a limits on the
magnitude of the observed galaxy sample, and on the field of view. The halos
in our catalogue are populated by galaxies and given magnitudes according to
the semi-analytic model of \citet{DeLucia+Blaizot2007}: by applying magnitude
cuts to our catalogue, we can investigate the amount of scatter caused by
unobserved halos. 

\Fref{fig:where} shows the cumulative contribution to $\kappah$ as a function
of projected distance from the line of sight, magnitude and redshift.
We find that most of the convergence comes from halos whose
galaxies are close to the line of sight. 
Over half of the  convergence
typically comes from halos within 30 arcseconds of the line of sight; by 2
arcminutes, this fraction is XX\%. \todo{Tom}{Put a number on this.} 
As a function of magnitude, we find
that $\kappah$ is dominated by objects with magnitudes between $i=18$ and
$i=24$. Objects brighter than $i=18$ are either too rare, or too close to the
observer, to make a significant contribution to the convergence. Objects
fainter than $i=24$ are too small to be important, unless they are extremely
close to the line of sight, but we find that including halos fainter than
$i=24$ does not improve the reconstruction.  \Fref{fig:magcut} shows the
scatter on $\kappah-\kappa$ (where $\kappah$ is shifted so that its mean is
zero) as a function of reconstruction magnitude limit. 
%
% Since these objects
% must be extremely close to the line of sight to make a non-zero $\kappah$
% contribution, it is likely that neglecting stellar mass and using a spherical
% NFW prescription are too naive to adequately reconstruct $\kappax$.
%
% PJM: the sentence above does not make sense!
%
We do
not expect a deeper survey to decrease the size of the uncertainty in mapping
$\kappah$ onto $\kappa$. Halos at all redshifts out to the source redshift
(1.4, here) contribute to the convergence, but the largest contribution comes from
halos with $z \sim z_{\rm source}/2$.

\begin{figure}
\includegraphics[width=\columnwidth]{figs/mag_scatter.eps}
\caption[magcut]{The 16, 50 and 84\% confidence intervals on $\kappah$ minus
$\kappa$ as a function of the limiting $i$ band depth of the halo
reconstruction. $\kappah$ has been shifted such that
$\left\langle\kappah\right\rangle=0$. The majority of the constraining power
comes from reconstructing halos with magnitudes between $18<i<24$.}
\label{fig:magcut}
\end{figure}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Testing the Halo Model Reconstruction on Mock Galaxy Catalogs}
\label{sec:obsMstar+z}

We now move on to consider the halo model reconstruction of line of sight mass
distributions given noisy astronomical observables. A typical imaging survey
can be expected to provide measurements of the positions and magnitudes of
galaxies in a field;  spectra for some of the objects may either come from a
synergistic survey, or from targeted follow-up. In this section we quantify
the errors induced by inferring the halo mass and redshift from these
observables. 

As described in \Sref{sec:model:halos}, in this work we infer halo masses
given measurements of stellar mass. We will investigate two main sources of
error: inferring halo mass given observed stellar mass, and placing halos at
the wrong redshift due to photometric redshift error. Much work has already
focused on using photometric colours to infer stellar mass
\citep[\eg][]{AugerEtal2009} and redshifts \citep[\eg][]{BPZ}: we will
estimate the likely uncertainties on stellar mass and redshift based on this
work.  

\subsection{Making Mock Observational Catalogs}

While the \MS catalogs do already contain stellar masses for each galaxy, we
find that these are not well behaved... \todo{Tom}{Explain why we re-made the
stellar masses}. We also wanted to be able to perform the functional test of
trying to recover the convergence having assumed the correct stellar
mass--halo mass relation. For these reasons, we assign a new stellar mass to
each halo in the \MS catalogs, according to the stellar mass--halo mass
relation of  \citet{BehrooziEtal2010}. From this true  stellar mass we
simulate an observed stellar mass by drawing a sample from 
$\pr(\log{M^{*}_{\rm obs}}|\log{M^{*}_{\rm true}})$ which we take to be a
Gaussian of width $\sigma_{M_*}$ centred on $\log(M*_{\mathrm {true}})$. Where
a spectroscopic redshift exists stellar masses can be estimated with typical
uncertainties of 0.15 dex \citep{AugerEtal2009}; however with photometric
redshifts stellar mass uncertainties are typically three times as large. We
use $\sigma_{M_*}=0.15$ for halos with a spectroscopic redshift and
$\sigma_{M_*}=0.45$ otherwise. For photometric redshift errors we draw a
redshift from $\pr(z_{\rm true}|z_{\rm obs})$ which we take to be a Gaussian
of width $0.1(1+z_{\rm spec})$ centred on $z_{\rm spec}$, where $z_{\rm spec}$
is the halo's true redshift in the \MS catalogue.


\subsection{Reconstructing $\kappa$ given a spectroscopic redshift for every object}

Given an uncertain stellar mass and redshift it is possible to infer a
halo mass using the stellar mass--halo mass relation of
\citet{BehrooziEtal2010}. This \proceedure requires an inversion of the
relation given in \citet{BehrooziEtal2010} and correctly inverting the
relation's uncertainties requires care: the \proceedure we use to do this
is given in \Aref{appendix:MSMH}. By drawing sample halo masses
and redshifts, we can infer a sample $\kappah$ using the \proceedure of
\Sref{sec:model}; repeatedly drawing samples allows us to
estimate $\pr(\kappah|\data)$ for each reconstructed line of sight. We then
transform this into our target PDF $\pr(\kappa|\data)$.

\begin{figure}
\includegraphics[width=\columnwidth]{figs/Width.eps}
\caption{The widths of the \infered PDFs $\pr(\kappah|\data)$ for
$10^5$ lines of sight, given different quality of data. Blue:
spectroscopic redshift for every halo with $i<26$; Purple: 
spectroscopic redshift for every halo with $i<23$, and every halo with $i<24$
within 1 arcminute; Cyan: spectroscopic redshift for every halo with $i<22$; 
Green: all the objects in the field have only photometric redshifts.}
\label{fig:reconwidths}
\end{figure}

\begin{figure}
\includegraphics[width=\columnwidth]{figs/Widthvshilberrt.eps}
\caption{Width of the \infered PDF $\pr(\kappah|\data)$ versus the true
$\kappa$ along a line of sight. Blue assumes a spectroscopic redshift for
every halo, whilst green assumes only photometric redshifts. The width of the
\infered $\pr(\kappah|\data)$ increases with $\kappa$. 
\todo{Tom}{Check that you mean
$\kappah$ and not $\kappa$, and potentially change the graph!}}
\label{fig:widthsvsH}
\end{figure}

The best possible reconstructions of $\kappa$ will come from having a
spectroscopic redshift for every single object in each field
(\Fref{fig:reconwidths}).  In terms of telescope time, such a reconstruction
would be prohibitively expensive, but we investigate this scenario as an ideal
case. Reconstructing the lines of sight with perfect knowledge of the redshift
but an uncertain stellar mass, we find that the width of $\pr(\kappa|\data)$
grows with the expectation value of $\kappa$ (\Fref{fig:widthsvsH}). The low
$\kappa$ lines of sight are relatively empty, and so there are few
opportunities for uncertainties in the halo masses to \propogate into $\kappa$
uncertainties. The median reconstruction width in this idealised situations is
0.0123; some 22\% of lines of sight would have a reconstruction width less
than 0.01. 

% PJM: Note that I removed talk of void correction here - surely we should be
% just applying the method we describe and inferring $\kappa$?


\subsection{Reconstructing $\kappa$ from photometry alone}

Inferring the stellar mass of a galaxy from its magnitude and colours requires
an estimate of how far away the galaxy is; without a spectroscopic redshift
the \infered stellar mass is less precise. However, obtaining photometry has
much lower observational cost; over the next few years several large area
photometric surveys will reach 24th magnitude \citep{Euclid,LSST}, these will
provide sufficient data to reconstruct lines of sight {\it without} additional
observations. In principle the photometric redshift is correlated with the
\infered stellar mass, however we do not model this effect since the
convergence from the outskirts of an individual halo is only weakly \dependant
on redshift at fixed mass: the redshift error has only a small effect on the
inferred $\pr(\kappa|\data)$ when compared to the effect of uncertain stellar
masses.  With only photometric redshifts the uncertainty on
$\kappah$ is much larger than in the spectrocopic case and this
\propogates into a broader $\pr(\kappa|\data)$, although the photometric
reconstruction still typically produces a 40\% improvement compared to the
precision of the global $\pr(\kappa)$ (\Fref{fig:widthsvsH}).


\subsection{Reconstructing $\kappa$ with partial spectroscopic coverage}

While a fully photometric reconstruction provides useful constraints on
$\pr(\kappa|\data)$, targeted spectroscopy can provide addtional constraints
on the masses and redshifts of halos whose $\kappah$ contribution have the
largest absolute uncertainty. Obtaining spectra of bright ($i<22$) objects is
relatively fast with large telescopes: however, we find that if spectroscopic
redhsifts were known for all $i<22$ galaxies in our field the reconstruction
improves slightly upon the purely photometric reconstruction, although the
improvement can depend strongly on the details of the particular line of
sight. Obtaining spectra for fainter objects would be correspondingly more
expensive, but if spectroscopic redshifts could be obtained for all $i<23$
galaxies and all $i<24$ galaxies within 1 arcminute of the line of sight, the
$\pr(\kappa|\data)$ would be almost as good as having complete spectroscopic
coverage (\Fref{fig:reconwidths}). High $\kappa$ lines of sight benefit the
most from additional spectral coverage, since these LoS have the most
uncertain $\kappah$. Consistent with our previous findings the lowest $\kappa$
lines of sight have the most constrained $\kappa$ PDFs.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\section{Systematic Errors due to Sample Selection}
\label{sec:bias}

\begin{figure*}
\includegraphics[width=\textwidth]{figs/biasplots.eps}
\caption{Estimating $\kappa-\kappa_{\rm true}$ from subsets of
lenses. By subtracting the true (ray-traced) convergence from the
infered P($\kappa$) for each line of sight we are left with a PDF that
should be estimating zero, these can be multiplied together for multiple
lines of sight to test for a possible bias. These plots show the
expectation value of $\prod_{i=1}^N \pr_i(\kappa-\kappa_{\rm true})$ --
deviations from zero constitute biases. The solid, dashed and dotted
lines correspond to combinations of 
20, 5 and 2 sightlines respectively. Green lines show the results
from multiplying $\pr(\kappa|\data)$ \infered from photometry alone, whilst red
lines are from multiplying $\pr(\kappa)$ \infered from photometry and a
spectroscopic redshift for all halos with $i<23$ and all halos within 1
arcminute and $i<24$. The leftmost plot shows randomly selected lines
of sight. The central plot shows sight lines randomly selected from the
33\% of lines whose P($\kappa$) is most tightly constrained. The right
hand plot shows only lines of sight with external shear of 0.03 or
greater.}
\label{fig:biasplots}
\end{figure*}

While it is good to reconstruct $\kappa$ precisely, it is more important that
$\kappa$ is reconstructed accurately. 
% A precise, inaccurate $\kappa$ estimator
% is worse than useless for cosmology. 
% PJM: steady on.
We test the accuracy of our reconstructed $\pr(\kappa|\data)$ in the following
way: for each line of sight we shift the reconstructed $\pr(\kappa|\data)$ by
the line of sight's true value of $\kappa$ to give
$\pr(\kappa-\kappatrue|\data)$. Since the $\pr(\kappa-\kappatrue|\data)$ for
each line of sight is then an \independant estimator of zero, the PDFs can be
combined according to
\be
\label{eq:bias}
\mathcal{P}_N = \prod_{i=1}^N \pr_i(\kappa-\kappa_{\rm true})
\ee
In this section, we quantify the bias as the size of the deviation in the
expectation value of $\mathcal{P}_N$ from zero. If the bias of $\mathcal{P}_N$
is smaller than the half-width of $\mathcal{P}_N$, our $\kappa$ estimators can
be considered accurate. 
The point at which the modulus of the bias and the width of $\mathcal{P}_N$
are approximately equal gives an estimate of the number of objects which can
be combined before the measurement is limited by systematic error.


The source of systematic error that we investigate  is that of sample
selection: we define three different selections of lines of sight, and compute
the bias present in each one in turn, as a function of data quality. The
results described below are illustrated in \Fref{fig:biasplots}.


\subsubsection{Selecting random lines of sight}
\label{sec:bias:random}

We first consider a purley random selection of lines of sight. With the purely
photometric reconstruction, there is a small bias towards underestimating
$\kappa$: combining 6 targets the half-width and bias of $\mathcal{P}_{6}$
both equal 0.007. With targeted spectroscopic follow up this improves
slightly, for the combination of 8 sightlines the half-width and expectation
value  $\mathcal{P}_{8}$ equal 0.005.  If these lines of sight hosted time
delay lenses, the latter number would correspond to a systematic error of
0.5\% in time delay distance. Since strong lens modelling uncertainties are
typically at the 3-4\% level, a sample of 8 lenses would still be limited by
modelling uncertainty. However, a sample containing 100 or more lenses or more
would be limited by the external convergence reconstruction instead.


\subsubsection{Selecting only the lines of sight with tight $\pr(\kappax)$}
\label{sec:bias:tightPDF}

Since follow-up campaigns (such as high resolution imaging, or time
variability monitoring) are expensive, it is likely that only a subset of
detected objects will be observed further. By pre-selecting objects that have 
the most well constrained convergence, the cosmological value per lens can be
increased. However, this selection has the potential to induce a bias. It is
probable that only photometry will be available at the time of sub-sample
selection (although spectroscopic follow-up might be conducted at a later
date). We mimic such a selection by drawing lines of sight only from those in
the lowest third of $\sigma_{\kappa}$, given a purely photometric
reconstruction of their fields. 

We find that selecting the most tightly constrained lines of sight {\it
decreases} the bias -- our reconstruction is most \succesful for the lowest
$\kappa$ lines of sight. With photometry alone, the bias in this sample is
0.0028. With targeted spectroscopic follow-up of the selected lines of sight
there is negligible improvement, since the best constrained lines of sight are
the most empty, and it is the high-$\kappa$ lines of sight that benefit the
most from spectroscopy. Photometry of the field is sufficient to adequately
select the best lines of sight for cosmology -- and doing so greatly increases
both the precision and accuracy of the cosmological constraints per system.


\subsubsection{Selecting only high shear lines of sight}
\label{sec:bias:tightPDF}

Time delay lenses are often selected for follow-up based on their images'
brightness (to make monitoring observations less expensive), their images'
separation (to decrease the covariance between the ground-based image
lightcurves), or the fact that they are quadruply-imaging rather than
doubly-imaging, since this yields 3 time delays instead of 1, and a higher
magnification, more informative Einstein Ring system. All three of these
properties favour lenses with high convergence and shear along their lines of
sight. Focusing on the quad selection, we might expect many of these systems
to have significant external shear (since the cross-section for 4 image
production is so sensitive to ellipticity in the lens mass distribution (or
equivalently, external shear due to the lens' environment). 

By selecting only lines of sight with an external shear of $\gamma>0.03$ we
can test the impact of shear selection. We find that in this sample, $\kappa$
is systematically underestimated at the $\sim$0.01 level. Part of this effect
is mitigated if only the lines of sight with both $\gamma>0.03$ and sharp
$\pr(\kappax)$ are used but biases at the $\sim$0.005 level remain. Since our
model does not include shear constraints it is not surprising that selecting
based on shear can induce a bias. A more sophisticated model that includes the
shear recovered from the lens modelling may be less susceptable to this bias.
The toy model of this section ($\gamma>0.03$) is likely to be a much stronger
selection than reality, but it is worth noting that the reconstruction
\proceedure will be biased if lens selection functions are extreme and
unaccounted for.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%\section{Improving precision by including additional information}
%\notes{placeholder for shear}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Discussion}
\label{sec:discuss}

We have shown that reconstructing the matter due to halos along any line
of sight can improve the constraints on the external convergence along
that line of sight. The total convergence along a line of sight is
strongly correlated with the reconstructed $\kappah$. However since our
model ignores voids and assumes all halos follow a spherical
truncated-NFW profile our halo model does not include all of the relevant
physics; hence, the width of our resulting $\pr(\kappa|\data)$ is still
typically $\sim$0.01 for any given lightcone, even with a perfect
knowledge of every halo's virial mass and redshift. To make further
progress a more advanced treatment of both voids and halos will be
necessary. Interestingly, we have found that the most empty lines of
sight can be reconstructed with the most precision. $\kappa$ estimates
for empty
lines of sight receive few contributions from halos, and a large
contribution from voids; since they have the tightest PDFs after the
reconstruction it seems that our model's biggest uncertainties are
driven by naively reconstructing halos rather than neglecting voids.
With a photometric reconstruction of the field there is a significant
broadening, but the resulting precision is still typically 50\% 
higher than using the global $\kappa$ distribution. 

Since the uncertainty on $\pr(\kappa|\data)$ is $\sim$0.01 even
with perfect knowledge of halo mass and redshift, it seems that voids
(plus deviations from sphericity and dark matter clumping within the
main halo) dominate the total $\kappa$ uncertainty even with very
uncertain stellar masses. Inferring halo ellipticity and dark matter
clumping will likely always remain a difficulty for line of sight
reconstruction; but as \Fref{fig:magcut} shows, observing deeper
than 24th magnitude does not signifcantly help the reconstruction.
Because our reconstruction is mostly limited by the model, spectroscopic
coverage can only provide a modest improvement to the reconstruction and
at significant observational cost.

For a small fraction of lines of sight, $\pr(\kappa|\data)$ remains very
broad even after applying our reconstruction; these lines of sight are
typically the most overdense lines of sight in the universe. For
time-delay cosmography the most observationally expensive tasks are the
lightcurve monitoring and high resolution follow-up imaging and spectroscopy,
while making photometric observations of a
4$\times$4 arcminute patch of sky survey down to 24th magnitude is
relatively cheap. We have shown that with a single epoch observation of
the region around a strong lens it is possible to infer $\pr(\kappa|\data)$.
If a line of sight has a broad $\pr(\kappa|\data)$ it can be rejected {\it
before} the investment of follow-up. We find that
selecting only the lines of sight with the most tightly constrained
$\pr(\kappa)$ does not induce a bias in $\kappa$, and hence distance.

The method we have outlined can also be used to estimate the external shear
along a line of sight. Shear is an observable that can be extracted from
strong lens modelling, however there is a degeneracy between internal and
external shear. When the Einstein Ring data are very good it is possible to
disentangle external and internal shear \citep[\eg][]{xxx}, but there are
still significant uncertainties: \citet{WongEtal2011} attempted to match the
shear from strong lens models with a reconstruction of the local lens group
environment, but found a tension between the strong lens model and the
reconstruction of the environment. Since \citet{WongEtal2011} only
reconstructed the local lens group, rather than the full line of sight
contribution, it is unclear whether the external shear from lens models can be
reconciled with a line of sight reconstruction. {\it If} external shear can be
measured, it provides an additional constraint on which of the \MS lines of
sight are similar to the reconstructed line of sight. \citet{SuyuEtal2012}
found that for RXJ1131 combining shear constriants with galaxy number count
overdensity, gave a significantly different $\pr(\kappa|\gamma,N_{45})$
compared to the PDF from number count overdensity alone,
$\pr(\kappax|N_{45})$. While not included in this paper, we found that given
perfect knowledge of the halo mass and redshift the raytraced external shear
$\gamma$ and the reconstructed external shear $\gamma_{\mathrm{h}}$  are
similar, with 68 percent of lines obeying
\be
\label{eq:shearineq}
|{\boldmath{\gamma}-\boldmath{\gamma_{\mathrm{h}}}}| < \mathrm{0.025}
\ee 
Future work should investigate whether $\gamma_{\mathrm{h}}$ can be used
to improve the accuracy and precision of $\kappa$ estimation, given a
reconstruction of the line of sight. 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{figure}
\includegraphics[width=\columnwidth]{figs/biasplots3.eps}
\caption{}
\label{fig:no-median-tricks}
\end{figure}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

The reduction of $\pr(\kappah|\data)$ to just its median value, before using
it to look up the appropriate $\pr(\kappa)$ from the simulated sightline
ensemble, is reminiscent of the procedure followed by \citet{SuyuEtal2010},
and Greene et al (in prep.) The reconstruction method can be seen as the
limiting case of the weightings explored by Greene et al: rather than using
weighted number counts in an aperture, we treat each galaxy individually, and
predict  $\kappa_{\rm h,obs}^{\rm med}$ for use in their place. One
significant disadvantage of these types of method is that they impose a
bottleneck in the flow of information. Once you have compressed to one number,
it is difficult to incorporate more information later; you have to recompute
all the calibrations. Using the full PDF for $\kappah$ is the more correct
thing to do: at present, however, it suffers from significant bias in the
photometric data case. \Fref{fig:no-median-tricks} shows how $\kappa$ is
overestimated, as a result of the high scatter in halo mass for objects with 
high stellar mass. Future work should increasing the precision of the halo
mass estimates. 

More generally, the \MS as a calibration tool. If the real Universe is not
like the \MS, then the calibration will be incorrect; repeating the study using
a different simulation to make the test catalogs would allow us to quantify
the sensitivity of our results to the simulation used. Similarly the use of a
different semi-analytic model to paint galaxies onto halos, and an alternative
stellar mass--halo mass relation would both enable similar exploration of
these systematic errors.

More generally, the method presented here is tied to the simulations at
several points: in particular, the prior PDF for $\kappah$, and the
conditional distribution $\pr(\kappa|\kappah)$ used to convert halo model
convergence to total convergence. The former tie could potentially be avoided
if the halo mass estimation gave rise to a reasonable $\pr(\kappah|\data)$ on
its own. Possibilities for improving the precision of the halo mass estimation
include incorporating a group and cluster finder, and then inferring halo mass
from optical richness \citep[\eg][]{MaxBCG} in tandem with BCG stellar mass,
and using additional galaxy scaling relations to make use of the luminosity
and size information present. The latter tie is more difficult, since breaking
it means modelling the unseen mass structures and voids from first principles.
In the wide field survey era, will it be possible to infer hierarchically the
parameters of a flexible model for these things from the data itself? Weak
lensing shears will be available over the whole Euclid and LSST survey areas:
constraining halo models using this information is an interesting possibility.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Conclusions}
\label{sec:conclude}

In this work we have investigated a simple halo model prescription for
reconstructing all the mass along a line of sight to an intermediate redshift
source. We have used the ray-traced lensing convergence along lines of sight
through the Millenium Simulation to test this approach, and to calibrate
estimates of the total convergence made by summing the convergences due to
each object in a photometric catalogue. Having found that the reconstruction
process is effective given perfect knowledge of halo mass and redshift, we
investigated the effects of reasonable uncertainties in the stellar mass and
redshift of each halo, and propagated these uncertainties into a
$\pr(\kappa|\data)$ for each line of sight. We also defined three different
possible line of sight selections, and investigated the bias induced by these
selections. We draw the following conclusions:

\begin{itemize} 

\item Our halo model uses a truncated spherical NFW profile for each dark
matter halo and neglects voids, but despite the model's simplicity the
reconstructed $\kappah$ is a good, if biased, tracer of $\kappa$.  We found
that with perfect knowledge of the halo mass and redshift (from the Millennium
Simulation catalogs), for a typical line of sight the reconstruction gives an
unbiased estimate of $\kappa$ that is a factor of 2 more precise than the
global $\pr(\kappa)$.

\item With uncertain halo masses and redshifts, we find that
$\pr(\kappah|\data)$ is still a useful indicator for inferring
$\pr(\kappa|\data)$ from the ensemble of simulated lines of sight, but the
resulting PDFs tend to be much broader than for perfect halo mass and redshift
reconstructions. The long tails of the $\kappah$ distribution can be
suppressed by focusing on the median value as an indicator for $\kappa$
instead.

\item  For the most overdense lines of sight, the reconstruction produces a
very broad PDF, but since the reconstruction can be performed before follow-up
time is invested it will be possible to discard the most uncertain lines of
sight and optimize the use of follow-up time. Photometric data is sufficient 
to select the best lines of sight for follow-up. Spectroscopic coverage helps
to tighten  $\pr(\kappa|\data)$ for high $\kappa$ lines of sight, but is of
limited use for  low $\kappa$ lines of sight.

\item It is very rare for halos further than 2 arcminutes from the line of
sight to make a significant contribution to $\pr(\kappa|\data)$. We also found
that including halos whose host galaxy is less luminous than $i=24$ does not
significantly improve our reconstruction precision. A photometric survey to
this depth of a 4$\times$4 arcminute patch around the lens would approach the
limiting uncertainties of our simple reconstruction recipe, and yield a 
$\pr(\kappa|\data)$ that has, on average, a width of 0.016. This is 1.5 times
less broad than the global $\pr(\kappa)$.

\item We find that the lines of sight with the sharpest inferred
$\pr(\kappa|\data)$ are typically under-dense. With a photometric
reconstruction of all lens fields, and following up only the lenses with the
most precise $\kappa$ estimates, the width of the dominant statistical
uncertainty in time-delay cosmography can be halved, without inducing biases
at the one percent level.

\end{itemize}

External convergence is not the only uncertainty in time delay cosmology,
but for systems like B1608 it is the dominant one. For most lines
of sight it is likely that lens modelling induces uncertainties at the
$\sim$3 percent level, which far exceeds the typical $\kappa$ uncertainties
after applying our reconstruction \proceedure. By using our method to
reconstruct lines of sight and select which lense are followed-up, the
uncertainties due to line of sight convergence will become a sub-dominant 
source of error.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%  ACKNOWLEDGMENTS
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section*{Acknowledgments}
 
We thank Risa Wechsler and Peter Behroozi 
for useful discussions and suggestions.
\input{acknowledgments.tex}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  APPENDICES
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\appendix

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Inferring $\Mhalo$ given a noisy measurement of $\Mstarobs$}
\label{appendix:MSMH}

To estimate the convergence caused by a halo we need to know its mass; how can 
halo mass be \infered from a noisy estimate of the stellar mass $\Mstarobs$
of a galaxy at redshift $z$. We seek the posterior
PDF $\Pr(\Mhalo|\Mstarobs,z)$, which can be expanded as follows:

\begin{eqnarray}
&& \Pr(\Mhalo|\Mstarobs,z) = \notag\\
&& \int d\Mstar \Pr(\Mhalo|\Mstar,z) \Pr(\Mstar|\Mstarobs,z), \notag\\
&\propto& \int d\Mstar \Pr(\Mstarobs|\Mstar) \Pr(\Mstar|\Mhalo,z) \Pr(\Mhalo|z),
\label{eq:mhalo-mstar}
\end{eqnarray}
where we have used Bayes' Theorem twice to replace
$\Pr(\Mhalo|\Mstar,z) \Pr(\Mstar|z)$ with 
$\Pr(\Mstar|\Mhalo,z) \Pr(\Mhalo|z)$, and 
to invert $\Pr(\Mstar|\Mstarobs)$ into the sampling
distribution $\Pr(\Mstar|\Mstarobs)$, which we recognise as the likelihood
function for the observed stellar mass. Note that the ``true'' $\Mstar$ of the
galaxy is marginalised out: we are only interested in infering the halo
mass. The last two terms in
\eqref{eq:mhalo-mstar} are the $\Mstar-\Mhalo$ relation from
\citet{BehrooziEtal2010}, and the halo mass function $\Pr(\Mhalo|z)$, at the
given redshift. We can
tabulate the product of these two from our Millenium Simulation catalog,
constructing a two-dimensional histogram of halo masses and their associated
true stellar masses (drawn from the Behroozi relation). 

For each galaxy, we compute the likelihood function for its $\Mstarobs$ as a
function of the unknown $\Mstar$, and multiply it by our tabulated joint PDF.
This heavily downweights halos with $\Mstar$ values outside the observed
range. We then do the marginalisation integral by Monte Carlo, drawing
(two-dimensional) sample parameter vectors
from the downweighted histogram, discarding the $\Mstar$ values, and
constructing a one-dimensional histogram that is an estimate of
$\Pr(\Mhalo|\Mstarobs)$.

If the redshift of the galaxy is uncertain, we need to take this
uncertainty into account; for example, for each sample drawn from the
photometric redshift posterior PDF $\Pr(z|{\rm colors})$, we can draw a
sample $\Mhalo$ using the above procedure.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%  REFERENCES
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% MNRAS does not use bibtex, input .bbl file instead. 
% Generate this in the makefile using bubble script in scriptutils:

% bubble -f paper-lcr.tex references.bib 
% \input{paper-lcr.bbl}

% \bibliographystyle{apj}
% \bibliography{references}

\input{references.tex}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\label{lastpage}
\bsp

\end{document}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
